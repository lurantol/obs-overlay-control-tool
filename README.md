# OBS Overlay Control Tool

Инструмент для управления текстовыми оверлеями OBS на танцевальных фестивалях
(West Coast Swing и аналогичные форматы).

---

## Назначение

Приложение предназначено для оператора трансляции и решает задачу
быстрого, безопасного и структурированного вывода текстовой информации в OBS:

- текущая номинация в эфире;
- текущая пара (для финалов);
- отборы / prelims / semis с Heat’ами;
- анонс следующего дивизиона (NEXT);
- показательные выступления (Special / Show / Formation);
- работа с реальными списками участников из CSV / Excel.

Приложение работает **локально**, без интернета, и управляет OBS через
текстовые файлы.

---

## Как это работает (общая схема)

1. Приложение запускается на ноутбуке оператора.
2. Управление осуществляется через браузер (Mac / iPad).
3. Приложение записывает текст в файлы.
4. OBS читает эти файлы через `Text (from file)` и автоматически обновляет эфир.

Связь с OBS осуществляется **только через файлы**, без WebSocket и плагинов,
что обеспечивает максимальную надёжность в эфире.

---

## Источники в OBS

Необходимо создать 3 текстовых источника:

- `out/current_title.txt` — что сейчас в эфире
- `out/current_pair.txt` — текущая пара или название номера
- `out/next_title.txt` — следующий дивизион (NEXT)

### Browser Source вместо Text Source (рекомендуется)

Если OBS периодически "съедает" символы при обновлении Text Source из файла, можно уйти на **Browser Source**.

Приложение отдаёт готовую страницу-оверлей:

- Current (title + pair):
  - `http://127.0.0.1:3000/overlay.html?mode=current`
- Next (только заголовок NEXT):
  - `http://127.0.0.1:3000/overlay.html?mode=next`

Параметры:
- `interval=300` — частота опроса (мс)
- `hideEmpty=1` — скрывать пустые строки (0/1)
- `titleSize=48px` / `pairSize=40px` — размеры текста

---

## Operator Mode (пульт для iPad)

С версии **Stage 2** добавлен **Operator Mode** — отдельный touch-first экран для оператора трансляции.

Доступные варианты открытия:
- внутри основной админки (вкладка **Operator Mode**)
- отдельной страницей (рекомендуется для iPad):
  - `http://<IP_Мака>:3000/operator`

В админке есть кнопка **Open in new tab**, которая открывает `/operator` в новой вкладке.

### Operator Mode → View

На View отображается:
- **ON AIR (Program)** — скриншот текущего Program
- **PREVIEW** — скриншот Preview (если включен Studio Mode)
- статус OBS WebSocket (Connected / Stale / Disconnected)

Кнопки управления и History на Stage 2 визуально готовы, но логика (история, выбор танцоров, apply) будет добавляться следующими этапами.

### Operator Mode → Settings

#### OBS Connection (OBS 32.0.4)
В OBS 32 WebSocket уже встроен, плагин не нужен.

1) В OBS открой:
   - **Tools → WebSocket Server Settings**
2) Включи сервер (Enable)
3) Порт по умолчанию: **4455**
4) Установи пароль (рекомендуется) и сохрани

Далее в Operator Mode → Settings:
- **Host**: обычно `localhost` (если приложение на той же машине, что и OBS)
- **Port**: `4455`
- **Password**: как в OBS

Кнопка **Test connection**:
- подключается к OBS
- показывает результат и Studio Mode статус

Кнопка **Reconnect** (вверху): переподключает OBS WebSocket.

#### Screenshots
Настройки обновления превью:
- **Update interval (sec)** — как часто обновлять превью (рекомендуется 1–2 сек)
- **Quality (10..100)** — качество JPG (70–80 обычно достаточно)
- **Resolution** — размер скриншота (1280×720 обычно комфортно)
- **Preview only if Studio Mode** — если включено, Preview будет пустым, когда Studio Mode выключен
- **Auto-refresh screenshots** — автообновление превью

---

---

## Вкладка «Эфир»

Основная рабочая панель оператора.

### Финалы
Используется для конкурсов с парами:
- выбор номинации;
- выбор любых двух участников;
- кнопка «Применить в эфир».

Результат:
- `current_title` — название финала;
- `current_pair` — «Имя — Имя».

Heat’ы отсутствуют.

---

### Отборы
Используется для prelims / semis:
- выбор номинации;
- выбор Heat кнопками;
- кнопка «Применить в эфир».

Результат:
- `current_title` — «Номинация • Heat X»;
- `current_pair` очищается.

---

### NEXT
Отдельный режим анонса:
- выбор следующей номинации;
- Heat — только для отборов;
- кнопка «Применить NEXT».

Результат:
- `next_title` — «NEXT: …».

---

### Special
Используется для показательных и шоу-выступлений:
- ProShow;
- Team Show;
- Formation;
- Guest Performance и т.п.

Логика:
- выбирается тип Special;
- выбирается участник/команда из списка, который задан в админке;
- кнопка «Применить в эфир».

Результат:
- `current_title` — тип выступления;
- `current_pair` — выбранный участник/команда.

---

## Вкладка «Админ»

Раздел подготовки и настройки.

### Номинации
- добавление финалов и отборов;
- указание типа (финалы / отборы);
- ограничение списка участников для конкретной номинации;
- настройка кнопок Heat.

---

### Special
Каталог типов показательных выступлений:
- добавление / редактирование типов (ProShow, Team Show и т.д.);
 - для каждого типа задаётся список строк (каждая строка — участник/пара/команда);
 - этот список потом используется во втором выпадающем списке во вкладке «Эфир → Special».
- используется в Эфире → Special.

---

### Импорт
Импорт участников из CSV / XLS / XLSX:

1. Загрузка файла.
2. Просмотр заголовков.
3. Выбор колонки с номером и колонки с именем.
4. Импорт данных.

Роли назначаются автоматически:
- нечётный номер → lead;
- чётный номер → follow.

Роль не ограничивает выбор в финалах.

---

## Запуск

### Требования
- macOS
- Node.js 18+
- OBS Studio

### Установка
```
npm install
```

### Запуск
```
npm start
```

### Открытие интерфейса
- Mac: http://localhost:3000
- iPad / другое устройство: http://IP_Мака:3000

---

## Почему такая архитектура

- файлы вместо WebSocket — максимальная стабильность;
- локальный сервер — независимость от интернета;
- чёткое разделение режимов;
- минимизация ошибок в эфире;
- подходит под реальные фестивальные сценарии.

---

## Целевая аудитория

- операторы OBS;
- медиакоманды танцевальных фестивалей;
- организаторы соревнований;
- ситуации с высокой нагрузкой и ответственностью за эфир.

## Новое в Stage 3–5

### Stage 3 — History (Undo/Redo)
- В Operator Mode добавлена история действий.
- Кнопки **Prev / Next** работают как **Undo / Redo**.
- История хранится в `data/history.json`.

### Stage 4 — Анимации (Browser Overlay)
- Анимации настраиваются во вкладке **Browser Overlay**:
  - для Title
  - отдельно для Leader и Follower
- Поддерживаемые типы:
  - None (нет)
  - Fade
  - Fade + Slide Up
  - Slide Left
  - Scale In
- Скорость задаётся в миллисекундах.

Как это работает:
- Operator Mode обновляет состояние оверлея и увеличивает `applyId`.
- Browser Overlay отслеживает изменения и проигрывает анимацию только для тех строк, которые изменились.

### Stage 5 — Presets оформления
- Можно сохранять наборы оформления (шрифты/размеры/цвета/анимации) как пресеты.
- Пресеты хранятся в `data/presets.json`.

UI:
- **Создать пресет** — вводишь имя и нажимаешь `Сохранить`
- **Применить** — выбираешь пресет и нажимаешь `Применить`
- **Удалить** — удаляет выбранный пресет

---

## Выбор танцоров из Finals (Operator Mode)

Сценарий:
1. В **Contest Setup** заранее настраиваешь участников для каждого финала (5 лидеров и 5 фолловеров и т.д.).
2. В Operator Mode → **View** нажимаешь **Choose dancers**.
3. Выбираешь финал (division), затем лидера и/или фолловера.
4. Нажимаешь:
   - **Apply leader** — применить только лидера
   - **Apply follower** — применить только фолловера
   - **Apply pair** — применить обоих
5. Опция **Без пары** выводит только одного человека (подходит для special/solo).

Важно:
- Списки для выбора берутся **только из Finals** и только из тех участников, которые назначены этому финалу.
- Применение идёт сразу: оверлей обновляется мгновенно (и может анимироваться, если анимации включены).

---

## Требования по OBS

- OBS версии: **32.0.4** (как у тебя).
- Для скриншотов в Operator Mode:
  - включи WebSocket в OBS (Tools → WebSocket Server Settings)
  - укажи host/port/password в Operator Mode → Settings.

